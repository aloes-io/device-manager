FROM nginx:latest

ARG HTTP_SERVER_PORT=8000
ARG WS_BROKER_PORT=3000
ARG MQTT_BROKER_PORT=1884
ARG NGINX_SERVER_HOST=localhost
ARG NGINX_HTTP_SERVER_PORT=80
ARG NGINX_MQTT_BROKER_PORT=1883

ENV HTTP_SERVER_PORT=${HTTP_SERVER_PORT}
ENV WS_BROKER_PORT=${WS_BROKER_PORT}
ENV MQTT_BROKER_PORT=${MQTT_BROKER_PORT}
ENV NGINX_SERVER_HOST=${NGINX_SERVER_HOST}
ENV NGINX_HTTP_SERVER_PORT=${NGINX_HTTP_SERVER_PORT}
ENV NGINX_MQTT_BROKER_PORT=${NGINX_MQTT_BROKER_PORT}

COPY ./nginx-gw.template /etc/nginx/nginx.template
# COPY ./config/nginx/nginx-gw.template /etc/nginx/nginx.template

RUN rm /etc/nginx/conf.d/default.conf

RUN ln -sf /dev/stdout /var/log/nginx/http-gw-access.log && ln -sf /dev/stderr /var/log/nginx/http-gw-error.log
RUN ln -sf /dev/stdout /var/log/nginx/mqtt-gw-access.log && ln -sf /dev/stderr /var/log/nginx/mqtt-gw-error.log

EXPOSE ${NGINX_HTTP_SERVER_PORT}
EXPOSE ${NGINX_MQTT_BROKER_PORT}

# ENTRYPOINT or CMD ?
CMD envsubst '$${HTTP_SERVER_PORT},$${WS_BROKER_PORT},$${MQTT_BROKER_PORT},$${NGINX_MQTT_BROKER_PORT},$${NGINX_HTTP_SERVER_PORT},$${NGINX_SERVER_HOST}' < /etc/nginx/nginx.template > /etc/nginx/nginx.conf && exec nginx -g 'daemon off;'
