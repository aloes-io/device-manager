# Aloes - Device Manager

- Replicate devices with rich semantic properties
- Authentification by access tokens and API keys
- Handle devices and sensors CRUD methods triggered via HTTP and MQTT
- MQTT events generated by HTTP operations hooks
- Dispatch MQTT payload from several protocol sources
- Adding context to sensors with OMA schemas
- Store devices and sensors state ( MongoDB )
- Fast access to sensor resources ( Redis )
- Interact with external application and share selection of devices
- Automatically store sensors value in timeseries ( InfluxDB ), in file, or trigger some timers

[Swagger Explorer](https://supervisor.aloes.io/explorer)

[Full Docs](https://aloes.frama.io/device-manager/)

Application build upon :

- [NodeJS](https://nodejs.org/en/)
- [Loopback](https://loopback.io/doc/en/lb3/)
- [Aedes](https://github.com/mcollina/aedes)
- [Open Mobile Alliance](http://www.openmobilealliance.org/wp/OMNA/LwM2M/LwM2MRegistry.html)
- [Aloes-handlers](https://www.npmjs.com/package/aloes-handlers)
- [IoT-agent](https://www.npmjs.com/package/iot-agent)

---

## Prerequisites

- Install [MongoDB](https://www.mongodb.com/)

- Install [Redis](https://redis.io/)

- Install [InfluxDB](https://www.influxdata.com/)

- Install [Skyring](https://github.com/esatterwhite/skyring) to use external timers

## Folder structure

- /. --> Main application configuration, dependencies list, and launch scripts

- /bin --> contains some maintenance scripts - not needed yet

- /deploy --> contains environment variables ( hidden files )

- /log --> contains logs from PM2

- /storage --> contains folders where users files are stored

- /src --> contains source code
  - /. --> Loopback configuration
  - /boot --> code executed at application start
  - /initial-data --> JSON datasets to make global application running
  - /middleware --> scripts used in development/staging only
  - /mixins --> add special properties to models
  - /models --> REST API descriptions and controllers
  - /services --> external modules
  - /views --> templates used for automatic mailing

## HTTP API

URL pattern : +apiRoot/+modelPluralName/+path

Access controlled by Access tokens ( set in headers ) properties and roles for Users, and apiKey for Applications and Devices.

## MQTT API

Topic pattern : +userId/+modelName/+method/[+modelId]

Access controlled ( set in mqtt password ) by Access tokens for Users, and API Key for Applications and Devices.

## Configuration

Edit your config in .env_sample and save it as `.env`.
You can override these by populating `deploy` with files corresponding to an environment ( eg: .env_production ... ), and via pm2 `ecosystem.config.json` .

## Installation

```bash
  $ npm install
```

## Linting

```bash
  $ npm run lint
```

## Debug

- To set Aloes verbosity, configure SERVER_LOGGER_LEVEL from 0 to 4

- To activate Loopback debug

```bash
  $ DEBUG=loopback npm run start:dev
```

[More info...](https://loopback.io/doc/en/lb3/Setting-debug-strings.html)

## Starting project

Create or update `.env` file to match your enviroment.

For example to run in local mode, create `./deploy/.env_local` using `.env_sample` as an example.

### With Nodemon

```bash
  $ npm run start:local
```

### With PM2

- Starting PM2 processes :

```bash
  $ npm run start:pm2
```

- Stopping PM2 processes :

```bash
  $ npm run stop:pm2
```

### With Docker

You can serve the project with a distant server by filling `deploy` folder with files corresponding to an environment ( eg: .env_docker ), and then launching this app with docker via `docker-compose up`

Remember to update `*.dockerfile` to match your enviroment, if you don't use docker-compose.

Creating environment :

```bash
  $  npm run build:docker
```

Starting containers :

```bash
  $  npm run start:docker
```

Stopping containers :

```bash
  $  npm run stop:docker
```

## To deploy with your own TLS / SSL certificates

Read https://nodejs.org/api/tls.html#tls_tls_ssl

## To deploy with Localtunnel

Install your own instance : https://github.com/localtunnel/server

And then install wildcards certificates with : https://certbot.eff.org/

Finally, configure TUNNEL_HOST and TUNNEL_SECURE in your environment files.

## TODO

- Finish account linking with github
- Add user(s) in a team to easily share devices access ( via collaborators property )
- Data exports ( devices selection by filter )
- Catch and store data related to MQTT traffic ( via Specific sensor instance ? )
